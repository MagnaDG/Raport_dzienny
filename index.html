import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    onSnapshot, 
    deleteDoc, 
    doc,
    setLogLevel
} from 'firebase/firestore';

// --- Firebase Configuration ---
// These global variables are provided by the environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Main App Component ---
export default function App() {
    // --- State Management ---
    const [auth, setAuth] = useState(null);
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [tasks, setTasks] = useState([]);
    const [newTask, setNewTask] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    // --- Firebase Initialization and Authentication ---
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            
            // Enable debug logging for Firestore
            setLogLevel('debug');

            setAuth(authInstance);
            setDb(dbInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    console.log("User is signed in with UID:", user.uid);
                    setUserId(user.uid);
                } else {
                    console.log("No user signed in. Attempting to sign in...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(authInstance);
                            console.log("Signed in anonymously.");
                        }
                    } catch (authError) {
                        console.error("Error during sign-in:", authError);
                        setError("Failed to authenticate. Please refresh the page.");
                    }
                }
                 // Initial loading is done once we have a user or tried to sign in.
                setIsLoading(false);
            });
            
            return () => unsubscribe();

        } catch (e) {
            console.error("Error initializing Firebase:", e);
            setError("Could not initialize the application.");
            setIsLoading(false);
        }
    }, []);

    // --- Real-time Data Fetching ---
    // This effect runs ONLY after userId and db are set, fixing the permission error.
    useEffect(() => {
        if (db && userId) {
            console.log(`Setting up snapshot listener for user ${userId}`);
            const tasksCollectionPath = `artifacts/${appId}/users/${userId}/tasks`;
            
            try {
                const unsubscribe = onSnapshot(collection(db, tasksCollectionPath), (snapshot) => {
                    const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Received updated tasks:", tasksData);
                    setTasks(tasksData);
                }, (err) => {
                    // This will now catch permission errors if they still occur.
                    console.error("Error in onSnapshot listener:", err);
                    setError("Failed to listen for task updates. Check database rules or connectivity.");
                });

                // Cleanup the listener when the component unmounts or dependencies change.
                return () => {
                    console.log("Cleaning up snapshot listener.");
                    unsubscribe();
                };
            } catch (e) {
                 console.error("Error creating collection reference:", e);
                 setError("There was an issue setting up data synchronization.");
            }
        } else {
            console.log("Skipping snapshot setup: db or userId not ready.");
        }
    }, [db, userId, appId]); // Correct dependencies

    // --- Firestore Actions ---
    const addTask = async (e) => {
        e.preventDefault();
        if (!newTask.trim() || !db || !userId) return;

        try {
            const tasksCollectionPath = `artifacts/${appId}/users/${userId}/tasks`;
            await addDoc(collection(db, tasksCollectionPath), {
                text: newTask,
                createdAt: new Date()
            });
            setNewTask('');
        } catch (err) {
            console.error("Error adding task:", err);
            setError("Failed to add the task.");
        }
    };

    const deleteTask = async (taskId) => {
        if (!db || !userId) return;
        try {
            const docPath = `artifacts/${appId}/users/${userId}/tasks/${taskId}`;
            await deleteDoc(doc(db, docPath));
        } catch (err) {
            console.error("Error deleting task:", err);
            setError("Failed to delete the task.");
        }
    };
    
    // --- UI Rendering ---
    return (
        <div className="bg-gray-900 text-white min-h-screen font-sans p-4 sm:p-6 md:p-8 flex items-center justify-center">
            <div className="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700">
                <header className="mb-6 text-center">
                    <h1 className="text-4xl font-bold text-cyan-400">Todo List</h1>
                    <p className="text-gray-400 mt-2">A real-time collaborative todo app.</p>
                     {userId && <p className="text-xs text-gray-500 mt-2 break-all">UserID: {userId}</p>}
                </header>

                {error && <div className="bg-red-500/20 text-red-300 p-3 rounded-lg mb-4 text-center">{error}</div>}

                {isLoading ? (
                     <div className="text-center text-gray-400">Initializing...</div>
                ) : (
                    <>
                        <form onSubmit={addTask} className="flex gap-3 mb-6">
                            <input
                                type="text"
                                value={newTask}
                                onChange={(e) => setNewTask(e.target.value)}
                                placeholder="Add a new task..."
                                className="flex-grow bg-gray-700 text-white placeholder-gray-500 rounded-lg px-4 py-3 border-2 border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all"
                            />
                            <button
                                type="submit"
                                className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={!newTask.trim()}
                            >
                                Add
                            </button>
                        </form>

                        <div className="space-y-3">
                            {tasks.length > 0 ? (
                                tasks.map(task => (
                                    <div key={task.id} className="bg-gray-700 rounded-lg p-4 flex justify-between items-center transition-all hover:bg-gray-600/50">
                                        <p className="text-gray-200">{task.text}</p>
                                        <button
                                            onClick={() => deleteTask(task.id)}
                                            className="text-red-400 hover:text-red-300 transition-colors font-semibold"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center text-gray-500 py-6">
                                    <p>No tasks yet. Add one above!</p>
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}
